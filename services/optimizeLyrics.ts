
import { generateContentWithRetry } from './geminiUtils';
import { GEMINI_MODELS } from './config';

export async function optimizeLyrics(fullPrompt: string, originalLyrics: string, model: string = GEMINI_MODELS.TEXT): Promise<string> {
  const prompt = `
# 役割 (Role)

あなたは、音楽生成AI「Suno」の日本語歌詞の発音精度を最大化するための、高度なプロンプトエンジニアです。あなたのタスクは、与えられたSuno AIプロンプト全体の中から**歌詞の部分のみ**を抽出し、AIが誤読する可能性を完全に排除した最終的な入力テキストに変換することです。

# 背景と目的 (Background & Objective)

Suno AIは、統計的予測に基づいてテキストから音声を生成します。このプロセスは、日本語特有の以下の課題により、読み間違い（誤読）を頻繁に引き起こします。

1.  **漢字の多音性:** 日本語の漢字は、文脈によって読み方が変わるものが多数存在します（例：「明日」→あした/あす）。AIは歌詞のような芸術的文脈の判断が苦手なため、意図しない発音を選択するリスクがあります。
2.  **文法機能による発音変化:** 助詞の「は」や「へ」は、文字本来の音（ha, he）と実際の発音（wa, e）が異なります。AIはこれを文法的に認識できず、文字通りの音で発音してしまうことがあります。
3.  **学習データの限界:** 固有名詞、専門用語、あるいは意図的な「当て字」はAIの学習データに含まれていない可能性が高く、文字を個別に音読み・訓読みしようとして全く違う発音になることがあります。
4.  **英語の扱い:** 日本語の文脈に英単語が含まれる場合、日本語話者としての自然な発音（カタカナ読み）をAIに強制する必要があります。

本プロンプトの目的は、これらのAIの解釈の曖昧さを完全に排除し、制作者の意図した通りの正確な歌唱を生成させることにあります。

# 【最重要】文脈理解のための情報 (Most Important: Contextual Information)

以下の「変換対象プロンプト」には、\`[Cmaj7]\`のようなコード指定が歌詞の単語の途中に挿入されている場合があります。（例：\`[C]かん[G]どうてき[Am]な\`）
これにより単語が分断され、AIが正しい読みを判断できなくなる可能性があります。

この問題を解決するため、コードが挿入される前の**「オリジナルの歌詞全文」**を参考に提供します。
このオリジナル歌詞を使って、分断された単語の**正しい文脈と読み方**を正確に理解し、変換処理を実行してください。

## オリジナルの歌詞全文（文脈理解用）
---
${originalLyrics}
---

# 重要ルール：メタタグの維持

Suno AIのプロンプトには、\`[Verse]\`や\`[Instrument: Piano]\`、歌詞中のコード指定\`[Cmaj7]\`のような角括弧 \`[ ]\` で囲まれたメタタグが含まれています。これらのメタタグは**絶対に、いかなる変更も加えてはなりません**。あなたのタスクは、これらのメタタグに囲まれていない、**純粋な歌詞の部分だけ**を対象に変換処理を行うことです。

# 実行命令 (Execution Orders)

以下の階層的なルールセットに従い、与えられたプロンプトの歌詞テキスト部分をSuno AIへの最終入力形式に変換してください。

## 第1原則：完全な表音文字化 (Complete Phonetic Conversion)

これは、誤読を防ぐための**絶対的な基本原則**です。

*   **命令1.1 (日本語・英語の処理):** 歌詞に含まれる全ての**漢字、カタカナ、英単語、アルファベット**を、例外なく表音文字である「ひらがな」または「カタカナ」に変換してください。
    *   **多音語の明確化:** 複数の読み方が存在する単語は、意図する歌詞の文脈から最も自然で芸術的な読み方を判断し、ひらがなで明示的に指定すること。
    *   **固有名詞・特殊な読みの強制:** 人名、地名、熟語、当て字など、AIが誤読する可能性のある全ての単語は、正しい読みに変換すること。（例：\`雪崩\` → \`なだれ\`、歌詞カード上で\`地球\`と表記し\`ほし\`と歌わせたい場合は\`ほし\`）
    *   **英語の分は変換の除外:** 英単語が複数続く場合（例：one more、show me）は、変換処理の対象外とする。)
    *   **英単語のカタカナ変換:** 英単語やアルファベットは、日本語の文脈で自然に発音されるカタカナ表記に変換してください。（例: \`love\` → \`ラブ\`, \`AI\` → \`エーアイ\`, \`sunshine\` → \`サンシャイン\`)
    *   **ニュアンス制御のための表記選択:**
        *   **ひらがな (デフォルト):** 最も自然で滑らかな歌唱を生成するための基本表記。
        *   **カタカナ (強調・特殊表現):** 意図的に硬質・無機質な発音をさせたい日本語や、日本語として定着した外来語、英単語に使用する。（例: \`凄い\` → \`スゴイ\`, \`love\` → \`ラブ\`)

## 第2原則：ローマ字によるピンポイント発音強制 (Pinpoint Control via Romaji)

総ふりがな化を適用した後、特定の助詞に対して以下の例外処理を**必ず**実行してください。これは、AIが文法機能を認識できないことに起因する特定の発音エラーを回避するための唯一の確実な手段です。

*   **命令2.1 (助詞「は」の置換):** 助詞として機能する「は」は、すべて \`wa\` に置換すること。
    *   **例:** \`きみはすてきだ\` → \`kimi wa suteki da\`
*   **命令2.2 (助詞「へ」の置換):** 助詞として機能する「へ」は、すべて \`e\` に置換すること。
    *   **例:** \`そらへむかう\` → \`sora e mukau\`

# 変換対象のプロンプト
---
${fullPrompt}
---

# 出力形式
変換後のプロンプト全体を出力してください。メタタグは完全に維持し、歌詞の部分のみが変換されている必要があります。説明や前置き、マークダウン（\`\`\`など）は一切含めないでください。
`;

  const response = await generateContentWithRetry({
    model: model,
    contents: prompt,
  });

  return response.text.trim();
}
